<div class="settings-page" data-testid="settings-page">
  <!-- Top bar -->
  <div class="settings-topbar">
    <h5 class="mb-0 fw-semibold">Settings</h5>
    @if (message(); as msg) {
      <span class="alert-inline" [class.alert-inline-success]="msg.type === 'success'" [class.alert-inline-danger]="msg.type === 'danger'" data-testid="settings-alert">
        <i class="bi" [class.bi-check-circle]="msg.type === 'success'" [class.bi-exclamation-triangle]="msg.type === 'danger'"></i>
        {{ msg.text }}
        <button class="btn-close btn-close-sm" (click)="dismissMessage()"></button>
      </span>
    }
  </div>

  <div class="settings-body">
    <!-- Vertical tabs -->
    <nav class="settings-nav">
      <button class="nav-tab" [class.active]="activeTab() === 'neo4j'" (click)="switchTab('neo4j')">
        <i class="bi bi-database"></i> Database
      </button>
      <button class="nav-tab" [class.active]="activeTab() === 'repos'" (click)="switchTab('repos')">
        <i class="bi bi-folder2-open"></i> Repositories
      </button>
      <button class="nav-tab" [class.active]="activeTab() === 'providers'" (click)="switchTab('providers')">
        <i class="bi bi-cpu"></i> AI Providers
      </button>
      <button class="nav-tab" [class.active]="activeTab() === 'tasks'" (click)="switchTab('tasks')">
        <i class="bi bi-list-task"></i> AI Tasks
      </button>
    </nav>

    <!-- Tab content -->
    <div class="settings-content">

      <!-- ═══════════════════ Neo4j Connection ═══════════════════ -->
      @if (activeTab() === 'neo4j') {
        <div data-testid="neo4j-card">
          @if (editingSection() === 'neo4j') {
            <!-- EDIT MODE -->
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="section-title mb-0"><i class="bi bi-database me-2"></i>Neo4j Connection</h6>
              <div class="d-flex gap-2">
                <button class="btn btn-primary btn-sm" (click)="saveSection()" data-testid="save-neo4j">
                  <i class="bi bi-check-lg me-1"></i>Save
                </button>
                <button class="btn btn-outline-secondary btn-sm" (click)="cancelEditing()">Cancel</button>
              </div>
            </div>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">URI</label>
                <input type="text" class="form-control" [value]="config().neo4j.uri"
                       (input)="updateNeo4jField('uri', $any($event.target).value)" data-testid="neo4j-uri">
              </div>
              <div class="col-md-6">
                <label class="form-label">Database</label>
                <input type="text" class="form-control" [value]="config().neo4j.database"
                       (input)="updateNeo4jField('database', $any($event.target).value)" data-testid="neo4j-database">
              </div>
              <div class="col-md-6">
                <label class="form-label">Username</label>
                <input type="text" class="form-control" [value]="config().neo4j.username"
                       (input)="updateNeo4jField('username', $any($event.target).value)" data-testid="neo4j-username">
              </div>
              <div class="col-md-6">
                <label class="form-label">Password</label>
                <input type="password" class="form-control" [value]="config().neo4j.password"
                       (input)="updateNeo4jField('password', $any($event.target).value)" data-testid="neo4j-password">
              </div>
            </div>
            <div class="mt-3">
              <button class="btn btn-outline-secondary btn-sm" (click)="testConnection()" [disabled]="testingConnection()" data-testid="neo4j-test-connection">
                <i class="bi bi-plug me-1"></i>
                {{ testingConnection() ? 'Testing...' : 'Test Connection' }}
              </button>
            </div>
          } @else {
            <!-- READONLY MODE -->
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="section-title mb-0"><i class="bi bi-database me-2"></i>Neo4j Connection</h6>
              <button class="btn btn-outline-primary btn-sm" (click)="startEditing('neo4j')" [disabled]="editingSection() !== null" data-testid="edit-neo4j">
                <i class="bi bi-pencil me-1"></i>Edit
              </button>
            </div>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">URI</label>
                <div class="field-value" data-testid="neo4j-uri-value">{{ config().neo4j.uri || '—' }}</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Database</label>
                <div class="field-value" data-testid="neo4j-database-value">{{ config().neo4j.database || '—' }}</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Username</label>
                <div class="field-value" data-testid="neo4j-username-value">{{ config().neo4j.username || '—' }}</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Password</label>
                <div class="field-value" data-testid="neo4j-password-value">••••••••</div>
              </div>
            </div>
            <div class="mt-3">
              <button class="btn btn-outline-secondary btn-sm" (click)="testConnection()" [disabled]="testingConnection()" data-testid="neo4j-test-connection">
                <i class="bi bi-plug me-1"></i>
                {{ testingConnection() ? 'Testing...' : 'Test Connection' }}
              </button>
            </div>
          }
        </div>
      }

      <!-- ═══════════════════ Repositories ═══════════════════ -->
      @if (activeTab() === 'repos') {
        <div data-testid="repositories-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="section-title mb-0"><i class="bi bi-folder2-open me-2"></i>Repositories</h6>
            <button class="btn btn-outline-primary btn-sm" (click)="addRepository()" [disabled]="editingSection() !== null" data-testid="add-repository">
              <i class="bi bi-plus-lg me-1"></i>Add Repository
            </button>
          </div>

          <div class="repo-layout">
            <!-- Repo list -->
            <div class="repo-list">
              @for (repo of config().repositories; track $index) {
                <button
                  class="repo-item"
                  [class.active]="selectedRepoIndex() === $index"
                  (click)="selectRepo($index)"
                  [attr.data-testid]="'repo-' + $index"
                >
                  <i class="bi bi-folder2"></i>
                  <span class="repo-item-name">{{ repo.name || 'New repository' }}</span>
                  <span class="repo-item-count">{{ repo.modules.length }}</span>
                </button>
              }
              @empty {
                <p class="text-muted small px-3 py-2 mb-0" data-testid="no-repos-message">No repositories configured.</p>
              }
            </div>

            <!-- Repo detail -->
            <div class="repo-detail">
              @if (selectedRepoIndex() !== null && config().repositories[selectedRepoIndex()!]; as repo) {
                @let repoIndex = selectedRepoIndex()!;

                @if (editingSection() === 'repo-' + repoIndex) {
                  <!-- ─── REPO EDIT MODE ─── -->
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="fw-semibold">{{ repo.name || 'New repository' }}</span>
                    <div class="d-flex gap-2">
                      <button class="btn btn-primary btn-sm" (click)="saveSection()">
                        <i class="bi bi-check-lg me-1"></i>Save
                      </button>
                      <button class="btn btn-outline-secondary btn-sm" (click)="cancelEditing()">Cancel</button>
                    </div>
                  </div>

                  <div class="row g-3 mb-3 align-items-end">
                    <div class="col-md-4">
                      <label class="form-label">Name</label>
                      <input type="text" class="form-control" placeholder="Repository name"
                             [value]="repo.name" (input)="updateRepoName(repoIndex, $any($event.target).value)"
                             [attr.data-testid]="'repo-name-' + repoIndex">
                    </div>
                    <div class="col">
                      <label class="form-label">Path</label>
                      <input type="text" class="form-control" placeholder="/path/to/git/repo"
                             [value]="repo.path" (input)="updateRepoPath(repoIndex, $any($event.target).value)"
                             [attr.data-testid]="'repo-path-' + repoIndex">
                    </div>
                    <div class="col-auto">
                      <button class="btn btn-outline-danger btn-sm" (click)="removeRepository(repoIndex)" title="Remove repository"
                              [attr.data-testid]="'remove-repo-' + repoIndex">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>

                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted fw-semibold text-uppercase">Modules</small>
                    <div class="d-flex gap-2">
                      <button class="btn btn-outline-secondary btn-sm" (click)="addModule(repoIndex)"
                              [attr.data-testid]="'add-module-' + repoIndex">
                        <i class="bi bi-plus me-1"></i>Add Module
                      </button>
                      <button class="btn btn-outline-info btn-sm" (click)="analyzeRepository(repoIndex)"
                              [disabled]="analyzing() !== null" title="Detect modules with AI"
                              [attr.data-testid]="'analyze-repo-' + repoIndex">
                        @if (analyzing() === repoIndex) {
                          <span class="spinner-border spinner-border-sm me-1"></span>Analyzing...
                        } @else {
                          <i class="bi bi-robot me-1"></i>Detect
                        }
                      </button>
                    </div>
                  </div>

                  @for (mod of repo.modules; track $index) {
                    @let modIndex = $index;
                    <div class="module-card" [attr.data-testid]="'module-' + repoIndex + '-' + modIndex">
                      <div class="row g-2 mb-2 align-items-end">
                        <div class="col">
                          <label class="form-label">Name</label>
                          <input type="text" class="form-control form-control-sm" [value]="mod.name"
                                 (input)="updateModule(repoIndex, modIndex, 'name', $any($event.target).value)"
                                 [attr.data-testid]="'module-name-' + repoIndex + '-' + modIndex">
                        </div>
                        <div class="col-auto" style="min-width: 140px">
                          <label class="form-label">Type</label>
                          <select class="form-select form-select-sm" [value]="mod.type"
                                  (change)="updateModule(repoIndex, modIndex, 'type', $any($event.target).value)"
                                  [attr.data-testid]="'module-type-' + repoIndex + '-' + modIndex">
                            <option value="java">Java</option>
                            <option value="angular">Angular</option>
                          </select>
                        </div>
                        <div class="col">
                          <label class="form-label">Relative Path</label>
                          <input type="text" class="form-control form-control-sm" [value]="mod.relative_path"
                                 (input)="updateModule(repoIndex, modIndex, 'relative_path', $any($event.target).value)"
                                 [attr.data-testid]="'module-path-' + repoIndex + '-' + modIndex">
                        </div>
                        <div class="col-auto">
                          <button class="btn btn-outline-danger btn-sm" (click)="removeModule(repoIndex, modIndex)" title="Remove module"
                                  [attr.data-testid]="'remove-module-' + repoIndex + '-' + modIndex">
                            <i class="bi bi-x-lg"></i>
                          </button>
                        </div>
                      </div>
                      <div class="tech-chips">
                        @for (tech of technologiesForType(mod.type); track tech.key) {
                          <button
                            class="tech-chip"
                            [class.active]="mod.technologies?.includes(tech.key)"
                            (click)="toggleTechnology(repoIndex, modIndex, tech.key)"
                          >{{ tech.label }}</button>
                        }
                      </div>
                    </div>
                  }
                  @empty {
                    <p class="text-muted small mb-0" data-testid="no-modules-message">No modules configured. Click "Add Module" or "Detect" to detect modules.</p>
                  }

                } @else {
                  <!-- ─── REPO READONLY MODE ─── -->
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="fw-semibold">{{ repo.name }}</span>
                    <div class="d-flex gap-2">
                      <button class="btn btn-outline-primary btn-sm" (click)="startEditing('repo-' + repoIndex)" [disabled]="editingSection() !== null"
                              [attr.data-testid]="'edit-repo-' + repoIndex">
                        <i class="bi bi-pencil me-1"></i>Edit
                      </button>
                      <button class="btn btn-outline-warning btn-sm" (click)="startAnalysisJob(repoIndex)"
                              [disabled]="repo.modules.length === 0" title="Run source code analysis"
                              [attr.data-testid]="'run-analysis-' + repoIndex">
                        <i class="bi bi-lightning me-1"></i>Run Analysis
                      </button>
                    </div>
                  </div>

                  <div class="row g-3 mb-3">
                    <div class="col-md-4">
                      <label class="form-label">Name</label>
                      <div class="field-value">{{ repo.name }}</div>
                    </div>
                    <div class="col">
                      <label class="form-label">Path</label>
                      <div class="field-value">{{ repo.path }}</div>
                    </div>
                  </div>

                  @if (repo.modules.length > 0) {
                    <small class="text-muted fw-semibold text-uppercase d-block mb-2">Modules</small>
                    <table class="module-table">
                      <thead>
                        <tr>
                          <th>Name</th>
                          <th>Type</th>
                          <th>Relative Path</th>
                          <th>Technologies</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (mod of repo.modules; track $index) {
                          <tr>
                            <td>{{ mod.name }}</td>
                            <td>{{ mod.type }}</td>
                            <td>{{ mod.relative_path }}</td>
                            <td>
                              @if (mod.technologies?.length) {
                                <div class="tech-chips">
                                  @for (tech of mod.technologies; track tech) {
                                    <span class="tech-chip active">{{ knownTechnologies[tech]?.label || tech }}</span>
                                  }
                                </div>
                              }
                            </td>
                          </tr>
                        }
                      </tbody>
                    </table>
                  } @else {
                    <p class="text-muted small mb-0">No modules configured.</p>
                  }
                }
              } @else {
                <p class="text-muted">Select a repository from the list.</p>
              }
            </div>
          </div>
        </div>
      }

      <!-- ═══════════════════ AI Providers ═══════════════════ -->
      @if (activeTab() === 'providers') {
        <div data-testid="ai-providers-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="section-title mb-0"><i class="bi bi-cpu me-2"></i>AI Providers</h6>
            <button class="btn btn-outline-primary btn-sm" (click)="addAIProvider()" [disabled]="editingSection() !== null" data-testid="add-ai-provider">
              <i class="bi bi-plus-lg me-1"></i>Add Provider
            </button>
          </div>

          @for (provider of config().ai_providers; track $index) {
            @let providerIndex = $index;

            @if (editingSection() === 'provider-' + providerIndex) {
              <!-- EDIT MODE -->
              <div class="section-card editing" [attr.data-testid]="'ai-provider-' + providerIndex">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="fw-semibold">{{ provider.name || 'New provider' }}</span>
                  <div class="d-flex gap-2">
                    <button class="btn btn-primary btn-sm" (click)="saveSection()">
                      <i class="bi bi-check-lg me-1"></i>Save
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" (click)="cancelEditing()">Cancel</button>
                  </div>
                </div>
                <div class="row g-3 mb-2">
                  <div class="col-md-4">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-control" placeholder="e.g. OpenAI"
                           [value]="provider.name" (input)="updateAIProvider(providerIndex, 'name', $any($event.target).value)"
                           [attr.data-testid]="'ai-provider-name-' + providerIndex">
                  </div>
                  <div class="col-md-8">
                    <label class="form-label">Base URL</label>
                    <input type="text" class="form-control" placeholder="https://api.openai.com/v1"
                           [value]="provider.base_url" (input)="updateAIProvider(providerIndex, 'base_url', $any($event.target).value)"
                           [attr.data-testid]="'ai-provider-url-' + providerIndex">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">API Key</label>
                    <input type="password" class="form-control" placeholder="sk-..."
                           [value]="provider.api_key" (input)="updateAIProvider(providerIndex, 'api_key', $any($event.target).value)"
                           [attr.data-testid]="'ai-provider-key-' + providerIndex">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Default Model</label>
                    <input type="text" class="form-control" placeholder="gpt-4o"
                           [value]="provider.default_model" (input)="updateAIProvider(providerIndex, 'default_model', $any($event.target).value)"
                           [attr.data-testid]="'ai-provider-model-' + providerIndex">
                  </div>
                  <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-outline-danger btn-sm w-100" (click)="removeAIProvider(providerIndex)" title="Remove provider"
                            [attr.data-testid]="'remove-ai-provider-' + providerIndex">
                      <i class="bi bi-trash me-1"></i>Remove
                    </button>
                  </div>
                </div>
              </div>
            } @else {
              <!-- READONLY MODE -->
              <div class="section-card" [attr.data-testid]="'ai-provider-' + providerIndex">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="fw-semibold">{{ provider.name }}</span>
                  <button class="btn btn-outline-primary btn-sm" (click)="startEditing('provider-' + providerIndex)" [disabled]="editingSection() !== null"
                          [attr.data-testid]="'edit-ai-provider-' + providerIndex">
                    <i class="bi bi-pencil me-1"></i>Edit
                  </button>
                </div>
                <div class="d-flex gap-4 flex-wrap">
                  <div>
                    <label class="form-label">Base URL</label>
                    <div class="field-value">{{ provider.base_url }}</div>
                  </div>
                  <div>
                    <label class="form-label">API Key</label>
                    <div class="field-value">••••••••</div>
                  </div>
                  <div>
                    <label class="form-label">Default Model</label>
                    <div class="field-value">{{ provider.default_model }}</div>
                  </div>
                </div>
              </div>
            }
          }
          @empty {
            <p class="text-muted" data-testid="no-providers-message">No AI providers configured. Click "Add Provider" to set up an OpenAI-compatible API.</p>
          }
        </div>
      }

      <!-- ═══════════════════ AI Tasks ═══════════════════ -->
      @if (activeTab() === 'tasks') {
        <div data-testid="ai-tasks-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="section-title mb-0"><i class="bi bi-list-task me-2"></i>AI Tasks</h6>
            <button class="btn btn-outline-primary btn-sm" (click)="addAITask()" [disabled]="editingSection() !== null" data-testid="add-ai-task">
              <i class="bi bi-plus-lg me-1"></i>Add Task
            </button>
          </div>

          @for (task of config().ai_tasks; track $index) {
            @let taskIndex = $index;

            @if (editingSection() === 'task-' + taskIndex) {
              <!-- EDIT MODE -->
              <div class="section-card editing" [attr.data-testid]="'ai-task-' + taskIndex">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="fw-semibold">{{ task.task_type || 'New task' }}</span>
                  <div class="d-flex gap-2">
                    <button class="btn btn-primary btn-sm" (click)="saveSection()">
                      <i class="bi bi-check-lg me-1"></i>Save
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" (click)="cancelEditing()">Cancel</button>
                  </div>
                </div>
                <div class="row g-3 mb-2">
                  <div class="col-md-4">
                    <label class="form-label">Task Type</label>
                    <select class="form-select" [value]="task.task_type"
                            (change)="updateAITask(taskIndex, 'task_type', $any($event.target).value)"
                            [attr.data-testid]="'ai-task-type-' + taskIndex">
                      <option value="repository_analysis">Repository Analysis</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Provider</label>
                    <select class="form-select"
                            (change)="updateAITask(taskIndex, 'provider_name', $any($event.target).value)"
                            [attr.data-testid]="'ai-task-provider-' + taskIndex">
                      <option value="" [selected]="!task.provider_name">-- Select Provider --</option>
                      @for (p of config().ai_providers; track p.name) {
                        <option [value]="p.name" [selected]="p.name === task.provider_name">{{ p.name }}</option>
                      }
                    </select>
                  </div>
                  <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-outline-danger btn-sm w-100" (click)="removeAITask(taskIndex)" title="Remove task"
                            [attr.data-testid]="'remove-ai-task-' + taskIndex">
                      <i class="bi bi-trash me-1"></i>Remove
                    </button>
                  </div>
                </div>
              </div>
            } @else {
              <!-- READONLY MODE -->
              <div class="section-card" [attr.data-testid]="'ai-task-' + taskIndex">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="d-flex gap-3 align-items-center">
                    <span class="fw-semibold">{{ task.task_type }}</span>
                    <i class="bi bi-arrow-right text-muted"></i>
                    <span class="text-muted">{{ task.provider_name || '(no provider)' }}</span>
                  </div>
                  <button class="btn btn-outline-primary btn-sm" (click)="startEditing('task-' + taskIndex)" [disabled]="editingSection() !== null"
                          [attr.data-testid]="'edit-ai-task-' + taskIndex">
                    <i class="bi bi-pencil me-1"></i>Edit
                  </button>
                </div>
              </div>
            }
          }
          @empty {
            <p class="text-muted" data-testid="no-tasks-message">No AI tasks configured. Click "Add Task" to map a task type to an AI provider.</p>
          }
        </div>
      }
    </div>
  </div>
</div>
