<div class="section-page" data-testid="jira-sprint-detail-page">
  <div class="section-topbar">
    <div class="d-flex align-items-center gap-2">
      <button class="btn btn-outline-secondary btn-sm" (click)="goBack()">
        <i class="bi bi-arrow-left me-1"></i>Sprints
      </button>
      @if (data(); as d) {
        <span class="fw-semibold">{{ d.sprint.name }}</span>
        <span class="badge" [class]="d.sprint.state === 'active' ? 'bg-primary' : 'bg-secondary'">{{ d.sprint.state }}</span>
      } @else {
        <h5 class="mb-0 fw-semibold">Sprint</h5>
      }
    </div>
    <div class="d-flex align-items-center gap-2">
      @if (refreshMessage()) {
        <span class="refresh-message">{{ refreshMessage() }}</span>
      }
      @if (data(); as d) {
        <span class="cache-info">
          @if (d.from_cache) {
            <i class="bi bi-database me-1"></i>Cached
          } @else {
            <i class="bi bi-cloud-download me-1"></i>Fresh
          }
          <span class="text-muted ms-1">{{ d._cached_at | date:'short' }}</span>
        </span>
      }
      @if (data()?.issues?.length) {
        <button class="btn btn-outline-secondary btn-sm" (click)="downloadAllIssues()" [disabled]="refreshingIssues()">
          @if (refreshingIssues()) {
            <span class="spinner-border spinner-border-sm me-1"></span>Downloading...
          } @else {
            <i class="bi bi-arrow-repeat me-1"></i>Download All Issues
          }
        </button>
      }
      <button class="btn btn-outline-secondary btn-sm" (click)="refresh()" [disabled]="loading()">
        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
      </button>
    </div>
  </div>

  <div class="section-content">
    @if (loading()) {
      <div class="d-flex justify-content-center py-5">
        <span class="spinner-border"></span>
      </div>
    } @else if (error()) {
      <div class="alert alert-danger m-3">
        <i class="bi bi-exclamation-triangle me-2"></i>{{ error() }}
      </div>
    } @else if (data(); as d) {
      <div class="sprint-header">
        <span class="text-muted">{{ d.issues.length }} issue(s)</span>
        @if (d.sprint.start_date) {
          <span class="text-muted ms-3"><i class="bi bi-calendar me-1"></i>{{ d.sprint.start_date | date:'mediumDate' }} – {{ d.sprint.end_date | date:'mediumDate' }}</span>
        }
      </div>
      <table class="issue-table" data-testid="sprint-detail-table">
        <thead>
          <tr>
            <th style="width: 40px"></th>
            <th style="width: 120px">Key</th>
            <th>Summary</th>
            <th style="width: 130px">Status</th>
            <th style="width: 100px">Priority</th>
            <th style="width: 150px">Assignee</th>
          </tr>
        </thead>
        <tbody>
          @for (issue of d.issues; track issue.key) {
            <tr class="issue-row" (click)="openIssue(issue.key)">
              <td><i class="bi" [class]="getTypeIcon(issue.issuetype)" [title]="issue.issuetype"></i></td>
              <td class="issue-key">{{ issue.key }}</td>
              <td>{{ issue.summary }}</td>
              <td><span class="status-badge" [class]="getStatusClass(issue.status)">{{ issue.status }}</span></td>
              <td>{{ issue.priority }}</td>
              <td>{{ issue.assignee || '—' }}</td>
            </tr>
          }
          @empty {
            <tr><td colspan="6" class="text-muted text-center py-3">No issues in this sprint.</td></tr>
          }
        </tbody>
      </table>
    }
  </div>
</div>
