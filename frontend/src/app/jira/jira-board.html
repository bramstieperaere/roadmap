<div class="jira-page" data-testid="jira-board-page">
  <div class="jira-topbar">
    <div class="d-flex align-items-center gap-2">
      <h5 class="mb-0 fw-semibold">Jira Sprint Board</h5>
      <a routerLink="/jira/metadata" class="btn btn-outline-secondary btn-sm" data-testid="metadata-link">
        <i class="bi bi-collection me-1"></i>Metadata
      </a>
    </div>
    <div class="d-flex align-items-center gap-2">
      @if (sprint(); as s) {
        <span class="cache-info" data-testid="cache-info">
          @if (s.from_cache) {
            <i class="bi bi-database me-1"></i>Cached
          } @else {
            <i class="bi bi-cloud-download me-1"></i>Fresh
          }
          <span class="text-muted ms-1">{{ s._cached_at | date:'short' }}</span>
        </span>
      }
      <button class="btn btn-outline-secondary btn-sm" (click)="refreshSprint()" [disabled]="loading() || !selectedProject()" data-testid="refresh-sprint">
        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
      </button>
    </div>
  </div>

  <div class="jira-body">
    <!-- Project list sidebar -->
    <nav class="jira-nav">
      @if (loadingProjects()) {
        <div class="p-3 text-center">
          <span class="spinner-border spinner-border-sm"></span>
        </div>
      } @else {
        @for (project of projects(); track project.key) {
          <button
            class="project-tab"
            [class.active]="selectedProject()?.key === project.key"
            (click)="selectProject(project)"
            [attr.data-testid]="'project-' + project.key"
          >
            <i class="bi bi-kanban"></i>
            <span class="project-tab-name">{{ project.name || project.key }}</span>
          </button>
        }
        @empty {
          <p class="text-muted small px-3 py-2">
            No projects configured.<br>
            <a routerLink="/settings">Go to Settings</a>
          </p>
        }
      }
    </nav>

    <!-- Sprint content -->
    <div class="jira-content">
      @if (loading()) {
        <div class="d-flex justify-content-center py-5">
          <span class="spinner-border"></span>
        </div>
      } @else if (error()) {
        <div class="alert alert-danger m-3" data-testid="sprint-error">
          <i class="bi bi-exclamation-triangle me-2"></i>{{ error() }}
        </div>
      } @else if (sprint(); as board) {
        <div class="sprint-header">
          <span class="fw-semibold">{{ board.sprint.name }}</span>
          <span class="badge bg-primary ms-2">{{ board.sprint.state }}</span>
          <span class="text-muted ms-2">{{ board.issues.length }} issue(s)</span>
        </div>

        <table class="sprint-table" data-testid="sprint-table">
          <thead>
            <tr>
              <th style="width: 40px"></th>
              <th style="width: 120px">Key</th>
              <th>Summary</th>
              <th style="width: 120px">Status</th>
              <th style="width: 100px">Priority</th>
              <th style="width: 140px">Assignee</th>
            </tr>
          </thead>
          <tbody>
            @for (issue of board.issues; track issue.key) {
              <tr class="issue-row" (click)="openIssue(issue.key)" [attr.data-testid]="'issue-' + issue.key">
                <td><i class="bi" [class]="getTypeIcon(issue.issuetype)" [title]="issue.issuetype"></i></td>
                <td class="issue-key">{{ issue.key }}</td>
                <td>{{ issue.summary }}</td>
                <td><span class="badge status-badge" [class]="getStatusClass(issue.status)">{{ issue.status }}</span></td>
                <td>{{ issue.priority }}</td>
                <td>{{ issue.assignee || 'â€”' }}</td>
              </tr>
            }
            @empty {
              <tr><td colspan="6" class="text-muted text-center py-3">No issues in this sprint.</td></tr>
            }
          </tbody>
        </table>
      } @else if (selectedProject()) {
        <p class="text-muted p-3">Select a project to view its active sprint.</p>
      }
    </div>
  </div>
</div>
