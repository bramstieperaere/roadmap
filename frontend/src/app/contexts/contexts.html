<div class="section-page" data-testid="contexts-page">
  <div class="section-topbar">
    <h5 class="mb-0 fw-semibold">Contexts</h5>
  </div>

  <div class="section-content">
    @if (error()) {
      <div class="alert alert-danger d-flex align-items-center gap-2" data-testid="contexts-error">
        <i class="bi bi-exclamation-triangle"></i>
        <span class="flex-grow-1">{{ error() }}</span>
        <button class="btn-close btn-close-sm" (click)="dismissError()"></button>
      </div>
    }

    <!-- Add context -->
    <div class="d-flex gap-2 mb-3" data-testid="contexts-add">
      <input type="text" class="form-control form-control-sm" placeholder="New context name..."
             [ngModel]="newName()" (ngModelChange)="newName.set($event)"
             (keydown)="onKeydown($event)"
             [disabled]="adding()" data-testid="contexts-name-input">
      <button class="btn btn-primary btn-sm" (click)="addContext()"
              [disabled]="!newName().trim() || adding()" data-testid="contexts-add-btn">
        @if (adding()) {
          <span class="spinner-border spinner-border-sm me-1"></span>
        } @else {
          <i class="bi bi-plus-lg me-1"></i>
        }
        Add
      </button>
    </div>

    <!-- Context list -->
    @if (loading()) {
      <div class="d-flex justify-content-center py-4">
        <span class="spinner-border spinner-border-sm"></span>
      </div>
    } @else if (contexts().length === 0) {
      <p class="text-muted small">No contexts yet. Add one above.</p>
    } @else {
      <div class="context-list" data-testid="contexts-list">
        @for (ctx of contexts(); track ctx.name) {
          <div class="context-card" [attr.data-testid]="'context-' + ctx.name">
            <a class="context-link" [routerLink]="['/contexts', ctx.name]"
               data-testid="context-link">
              <div class="d-flex align-items-center gap-2 flex-grow-1">
                <i class="bi bi-card-text text-muted"></i>
                <span class="fw-medium">{{ ctx.name }}</span>
              </div>
              <div class="d-flex align-items-center gap-1">
                <button class="btn btn-sm btn-icon text-muted add-child-btn"
                        (click)="showAddChild(ctx.name, $event)" title="Add sub-context">
                  <i class="bi bi-plus"></i>
                </button>
                <i class="bi bi-arrow-right text-muted"></i>
              </div>
            </a>
            @for (child of ctx.children; track child.name) {
              <a class="child-link" [routerLink]="['/contexts', ctx.name, child.name]"
                 data-testid="child-context-link">
                <div class="d-flex align-items-center gap-2 flex-grow-1">
                  <i class="bi bi-arrow-return-right text-muted tree-arrow"></i>
                  <i class="bi bi-card-text text-muted"></i>
                  <span class="fw-medium">{{ child.name }}</span>
                </div>
                <i class="bi bi-arrow-right text-muted"></i>
              </a>
            }
            @if (addingChildFor() === ctx.name) {
              <div class="child-add-row">
                <i class="bi bi-arrow-return-right text-muted tree-arrow"></i>
                <input type="text" class="form-control form-control-sm flex-grow-1"
                       placeholder="Sub-context name..."
                       [ngModel]="newChildName()" (ngModelChange)="newChildName.set($event)"
                       (keydown)="onChildKeydown($event)"
                       [disabled]="addingChild()">
                <button class="btn btn-primary btn-sm btn-icon" (click)="addChild()"
                        [disabled]="!newChildName().trim() || addingChild()">
                  @if (addingChild()) {
                    <span class="spinner-border spinner-border-sm"></span>
                  } @else {
                    <i class="bi bi-check-lg"></i>
                  }
                </button>
                <button class="btn btn-outline-secondary btn-sm btn-icon" (click)="cancelAddChild()">
                  <i class="bi bi-x-lg"></i>
                </button>
              </div>
            }
          </div>
        }
      </div>
    }
  </div>
</div>
